<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<link rel="apple-touch-icon" sizes="76x76" href="{{ url_for('static', filename='img/apple-icon.png') }}" />
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='img/favicon.png') }}" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />

	<title>Crime Detection</title>

	<meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0' name='viewport' />
    <meta name="viewport" content="width=device-width" />


    <!-- Bootstrap core CSS     -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet" />

    <!--  Material Dashboard CSS    -->
    <link href="{{ url_for('static', filename='css/material-dashboard.css') }}" rel="stylesheet"/>

    <!--  CSS for Demo Purpose, don't include it in your project     -->
    <link href="{{ url_for('static', filename='css/demo.css') }}" rel="stylesheet" />
 
    <!--     Fonts and icons     -->
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" rel="stylesheet">
    <link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300|Material+Icons' rel='stylesheet' type='text/css'>
</head>

<body>

	<div class="wrapper">
	    <div class="sidebar" data-color="red" data-image="{{ url_for('static', filename='img/sidebar-1.jpg') }}">
			<!--
		        Tip 1: You can change the color of the sidebar using: data-color="purple | blue | green | orange | red"

		        Tip 2: you can also add an image using data-image tag
		    -->

			<div class="logo">
				<a href="http://www.creative-tim.com" class="simple-text">
					Crime Detection Engine
				</a>
			</div>

	    	<div class="sidebar-wrapper">
				<ul class="nav">
					<li class="active">
	                    <a href="maps.html">
	                        <i class="material-icons">location_on</i>
	                        <p>Maps</p>
	                    </a>
	                </li>
	                <li>
	                    <a href="table.html">
	                        <i class="material-icons">content_paste</i>
	                        <p>Analysis</p>
	                    </a>
	                </li>
	                <li>
	                    <a href="typography.html">
	                        <i class="material-icons">library_books</i>
	                        <p>Records</p>
	                    </a>
	                </li>
	            </ul>
	    	</div>
		</div>

	    <div class="main-panel">
			<nav class="navbar navbar-transparent navbar-absolute">
				<div class="container-fluid">
					<div class="navbar-header">
						<button type="button" class="navbar-toggle" data-toggle="collapse">
							<span class="sr-only">Toggle navigation</span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
							<span class="icon-bar"></span>
						</button>
						<a class="navbar-brand" href="#">Crime Maps</a>
					</div>
					<div class="collapse navbar-collapse">
						<ul class="nav navbar-nav navbar-right">
							<li class="dropdown">
								<a href="#" class="dropdown-toggle" data-toggle="dropdown">
									<i class="material-icons">notifications</i>
									<span class="notification">5</span>
									<p class="hidden-lg hidden-md">Notifications</p>
								</a>
								<ul class="dropdown-menu">
									<li><a href="#">Mike John responded to your email</a></li>
									<li><a href="#">You have 5 new tasks</a></li>
									<li><a href="#">You're now friend with Andrew</a></li>
									<li><a href="#">Another Notification</a></li>
									<li><a href="#">Another One</a></li>
								</ul>
							</li>
						</ul>
					</div>
				</div>
			</nav>

			<div class="content" style="height:100%">
	            <div class="container-fluid" style="height:100%">
	                <div class="row" style="height:100%">
	                    <div class="col-md-4">
	                    	<div class="row" style="width:100%">
	                    		<div class="col-md-4" style="width:100%">
			                        <div class="card card-nav-tabs">
			                            <div class="card-header" data-background-color="purple">
											<div class="nav-tabs-navigation">
												<div class="nav-tabs-wrapper">
													<!-- <span class="nav-tabs-title">Tasks:</span> -->
													<ul class="nav nav-tabs" data-tabs="tabs">
														<li class="active">
															<a href="#search_id" data-toggle="tab">
																<i class="material-icons">vpn_key</i>
																Crime Id
															<div class="ripple-container"></div></a>
														</li>
														<li class="">
															<a href="#search_words" data-toggle="tab">
																<i class="material-icons">description</i>
																Key Word
															<div class="ripple-container"></div></a>
														</li>
													</ul>
												</div>
											</div>
										</div>
			                            <div class="tab-content">
											<div class="tab-pane active" id="search_id">
												<div class="card-content">
													<form>
														<div class="row">
					                                        <div class="col-md-6">
																<div class="form-group label-floating">
																	<label class="control-label">Crime Id</label>
																	<input id="crime_id_input" type="text" class="form-control" >
																</div>
					                                        </div>
					                                        <div class="col-md-6">
																<div class="form-group label-floating">
																	<label class="control-label">Limit</label>
																	<input id="si_limit_input" type="text" class="form-control" >
																</div>
					                                        </div>
					                                    </div>
					                                    <div class="row">
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">From Year</label>
																	<input id="si_from_year_input" type="text" class="form-control" oninput="limitDate('from')">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">From Month</label>
																	<input id="si_from_month_input" type="text" class="form-control" disabled="disabled" oninput="limitDate('from')">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">From Day</label>
																	<input id="si_from_day_input" type="text" class="form-control" disabled="disabled">
																</div>
					                                        </div>
					                                    </div>
					                                    <div class="row">
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">To Year</label>
																	<input id="si_to_year_input" type="text" class="form-control" oninput="limitDate('to')">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">To Month</label>
																	<input id="si_to_month_input" type="text" class="form-control" disabled="disabled" oninput="limitDate('to')">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">To Day</label>
																	<input id="si_to_day_input" type="text" class="form-control" disabled="disabled">
																</div>
					                                        </div>
					                                    </div>
													</form>
													<button id="search_id_btn" class="btn btn-primary pull-right">Search</button>
	                                    			<div class="clearfix"></div>
												</div>
											</div>
											<div class="tab-pane" id="search_words">
												<div class="card-content">
													<form>
														<div class="row">
					                                        <div class="col-md-6">
																<div class="form-group label-floating">
																	<label class="control-label">Key Words</label>
																	<input id="key_words_input" type="text" class="form-control" >
																</div>
					                                        </div>
					                                        <div class="col-md-6">
																<div class="form-group label-floating">
																	<label class="control-label">Limit</label>
																	<input id="sw_limit_input" type="text" class="form-control" >
																</div>
					                                        </div>
					                                    </div>
					                                    <!--<div class="row">
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">From Year</label>
																	<input id="sw_from_year_input" type="text" class="form-control" oninput="sw_enable_from_month()">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">From Month</label>
																	<input id="sw_from_month_input" type="text" class="form-control" oninput="sw_enable_from_day()" disabled="disabled">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">From Day</label>
																	<input id="sw_from_day_input" type="text" class="form-control" disabled="disabled">
																</div>
					                                        </div>
					                                    </div>
					                                    <div class="row">
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">To Year</label>
																	<input id="sw_to_year_input" type="text" class="form-control" oninput="sw_enable_to_month()">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">To Month</label>
																	<input id="sw_to_month_input" type="text" class="form-control" oninput="sw_enable_to_day()" disabled="disabled">
																</div>
					                                        </div>
					                                        <div class="col-md-4">
																<div class="form-group label-floating">
																	<label class="control-label">To Day</label>
																	<input id="sw_to_day_input" type="text" class="form-control" disabled="disabled">
																</div>
					                                        </div>
					                                    </div>//-->
					                                    <div class="row">
					                                    	<table class="table">
																<tbody>
																	<tr>
																		<td>
																			<div class="checkbox">
																				<label>
																					<input type="checkbox" name="optionsCheckboxes" checked>
																				</label>
																			</div>
																		</td>
																		<td>Enable to search similar words?</td>
																	</tr>
																</tbody>
															</table>
					                                    </div>
													</form>
													<button id="search_words_btn" class="btn btn-primary pull-right">Search</button>
					                                <div class="clearfix"></div>
												</div>
											</div>
										</div>
			                        </div>
			                    </div>
	                    	</div>
	                    	<!-- <div class="row" style="width:100%">
	                    		<div class="col-md-4" style="width:100%">
	                    			<div class="card" style="width:100%">
	                    				<div class="card-header" data-background-color="purple">
			                                <h4 class="title">Map Configuration</h4>
											<p class="category">Complete your profile</p>
			                            </div>
			                            <div class="card-content" id="test_legend">
			                            </div>
	                    			</div>
	                    		</div>
	                    	</div> -->
	                    </div>
						<div class="col-md-8" style="height:100%">
    						<div class="card" style="height:100%">
	                            <div class="card-content" style="height:100%">
	                                <div id="map"></div>
	                            </div>
	                        </div>
		    			</div>
	                </div>
	            </div>
	        </div>

	    </div>
	</div>

</body>

	<!-- Core JS Files   -->
	<script src="{{ url_for('static', filename='js/jquery-3.1.0.min.js') }}" type="text/javascript"></script>
	<script src="{{ url_for('static', filename='js/bootstrap.min.js') }}" type="text/javascript"></script>
	<script src="{{ url_for('static', filename='js/material.min.js') }}" type="text/javascript"></script>
	<script src="{{ url_for('static', filename='js/underscore.js') }}" type="text/javascript"></script>
	<script src="https://d3js.org/d3.v4.min.js"></script>

	<!-- Notifications Plugin -->
	<script src="{{ url_for('static', filename='js/bootstrap-notify.js') }}"></script>

	<!-- Main JS code -->
	<script src="{{ url_for('static', filename='js/maps.js') }}"></script>

	<!-- Google Maps Plugin -->
	<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD4g1uo-ONEqqnTYMWFww-7Rxbqgve6nsA" type="text/javascript"></script>

	<!-- Material Dashboard javascript methods -->
	<script src="{{ url_for('static', filename='js/material-dashboard.js') }}"></script>
	<script src="{{ url_for('static', filename='js/utils.js') }}"></script>

    <script>

    	maps.initGoogleMaps("map");
    	// Configuration of colorbar
    	var colorbarLength = 1000,
    		colorbar = d3.scaleLinear().domain([1,colorbarLength])
			.interpolate(d3.interpolateHcl)
			.range([d3.rgb("#007AFF"), d3.rgb("#FFF500")]);
		
		// Get dom elements by their Ids
		var searchIdBtn    = document.getElementById("search_id_btn"),
			searchWordsBtn = document.getElementById("search_words_btn");
			// getRemarksBtn  = document.getElementById("get_remarks");

		var queryMarkers = null;
		var queryLines   = null;

		// Onclick event for search Id button
		searchIdBtn.onclick = function () {
			var crimeId   = document.getElementById("crime_id_input").value,
				limit     = document.getElementById("si_limit_input").value,
				fromYear  = document.getElementById("si_from_year_input").value,
				fromMonth = document.getElementById("si_from_month_input").value,
				fromDay   = document.getElementById("si_from_day_input").value,
				toYear    = document.getElementById("si_to_year_input").value,
				toMonth   = document.getElementById("si_to_month_input").value,
				toDay     = document.getElementById("si_to_day_input").value;

			
			//Invoke a hint
			if(crimeId == "" || limit == ""){
				alert("Caution! \nBoth Crime ID and Limit Number must be filled! ");
			}

			// accordint to doc, 0 represents January and 11 represents December
			var startTime = new Date(fromYear, (fromMonth-1), fromDay, 0, 0, 0, 0),
				endTime   = new Date(toYear, (toMonth-1), toDay, 0, 0, 0, 0);

			var start_timestamp = startTime.getTime(),
				end_timestamp   = endTime.getTime()
			if (start_timestamp < 0) {
				start_timestamp = 0;
			}
			if (end_timestamp   < 0) {
				end_timestamp   = (Date.parse(new Date()));
			}


			var para = {
				startTime: start_timestamp, //getTime() returns number of milliseconds
				endTime: end_timestamp,		//So divided by 1000 to change to the number of seconds
				crimeId: crimeId,
				limit: limit
			};

			requestBackEnd(para, "/searchCrimeId").then(function (simPoints) {
				// Remove the current result on the map
				if (queryMarkers != null) {
					maps.clearMarkers(queryMarkers);
					queryMarkers = null;
				}
				// Remove the current lines on the map
				if (queryLines   != null) {
							maps.clearLines(queryLines);
							queryLines   = null;
				}

				// Prepare the points which be painted on the map
				var colorPoints = _.map(simPoints, function (point) {
					return {
						position: point["position"],
						color:  colorbar(005), //change color to blue//colorbar(Math.ceil((1-point["similarity"])*colorbarLength)),
						weight: point["similarity"] * 20, 
						// For info window
						id: point["id"],
						label: point["label"],
						text: point["text"],
						date: point["date"],
						priority: point["priority"]
					}
				});
				// Place the marker on the map
				queryMarkers = maps.createSimilarMarkers(colorPoints,[]);
			}, function (msg) {
				alert(msg);
			});
		};

		// Onclick event for search keywords button
		searchWordsBtn.onclick = function () {
			var keywords  = document.getElementById("key_words_input").value,
				limit     = document.getElementById("sw_limit_input").value;
				//fromYear  = document.getElementById("sw_from_year_input").value,
				//fromMonth = document.getElementById("sw_from_month_input").value,
				//fromDay   = document.getElementById("sw_from_day_input").value,
				//toYear    = document.getElementById("sw_to_year_input").value,
				//toMonth   = document.getElementById("sw_to_month_input").value,
				//toDay     = document.getElementById("sw_to_day_input").value;

			if(keywords == "" || limit == ""){
				var hintWords = "Caution! \nBoth Keywords and Limit Number must be filled! " ;
				alert(hintWords);
			}

			//var startTime = new Date(fromYear, fromMonth, fromDay, 0, 0, 0, 0),
			//	endTime   = new Date(toYear, toMonth, toDay, 0, 0, 0, 0);

			var para = {
			//	startTime: startTime.getTime(),
			//	endTime: endTime.getTime(),
				keywords: keywords,
				limit: limit
			};

			var reportTexts = [],
				basicInfos  = [];

			// Search crime records whose remarks field contains indicated keywords
			requestBackEnd(para, "/searchKeywords")
				// Extract ids from the matched crime records
				.then(
					function (matchedItems) {
						if (matchedItems.length <= 0) {
							// todo: 
						}

						//highlight keywords
						for(var i=0;i<matchedItems.length;i++){
							matchedItems[i]["remarks"] = maps.highlightKeywords(keywords,matchedItems[i]["remarks"]);
						}


						reportTexts = matchedItems;
						var ids = _.chain(matchedItems)
							.map(function(item){return _.values(item);})
							.unzip().last().value();
						return requestBackEnd({ crimeIds:  ids }, "/getBasicInfos"); }, 
					function (msg) {
						alert("failed 1");
					})
				.then(
					function (filterPoints) {
						var ids = _.map(filterPoints, function(item){return item["id"];});
						basicInfos = filterPoints;
						return requestBackEnd({crimeIds:  ids}, "/getSimilaritiesMatrix");
					},
					function (msg) {
						alert("failed 2");
					})
				// Plot points on the map based on the extracted ids
				.then(
					function (simMat) {
						// Remove the current result on the map
						if (queryMarkers != null) {
							maps.clearMarkers(queryMarkers,queryLines);
							queryMarkers = null;
						}
						// Remove the current lines on the map
						if (queryLines   != null) {
							maps.clearLines(queryLines);
							queryLines   = null;
						}
						// Prepare the points which be painted on the map
						var normalPoints = [];
						for (var i=0; i<reportTexts.length; i++) {
							normalPoints.push({
								position: basicInfos[i]["position"],
								color:    colorbar(500),
								weight:   10,
								// For info window
								id:    basicInfos[i]["id"],
								label: basicInfos[i]["label"],
								text:  reportTexts[i]["remarks"],
								date:  reportTexts[i]["update_date"],
								priority: basicInfos[i]["priority"]});
						}
						// Place lines on the map
						//console.log(requestBackEnd(para, "/searchKeywords"));
						if (simMat.length > 0) {
							queryLines = maps.createLines(normalPoints, simMat);
						}
						// Place the marker on the map
						queryMarkers = maps.createSimilarMarkers(normalPoints, queryLines); 

						//maps.showLines(queryLines);		
					},
					function (msg) {
						alert("failed 3");
					});

			

		};
		function limitDate(status) {
			if (status == "from"){
	 			var yearId  = "si_from_year_input",
	 			    monthId = "si_from_month_input",
	 			    dayId   = "si_from_day_input";
	 		}
	 		else if(status == "to"){
	 			var yearId  = "si_to_year_input",
	 			    monthId = "si_to_month_input",
	 			    dayId   = "si_to_day_input";	 			
	 		}

			var regExp = /[0-9]$/;
	    	var year  = document.getElementById(yearId).value.trim();
	    	var	month = document.getElementById(monthId).value.trim();
	    	var day   = document.getElementById(dayId).value.trim();

			if(year == "" || !regExp.test(year)){    	
	        	document.getElementById(monthId).setAttribute("disabled","disabled");
	        	document.getElementById(dayId).setAttribute("disabled","disabled");
	        	document.getElementById(monthId).value = "";
	        	document.getElementById(dayId).value = "";
	    	}
	    	else{
	    		document.getElementById(monthId).removeAttribute("disabled");

	        	if(month == "" || !regExp.test(month)){
	        		document.getElementById(dayId).setAttribute("disabled","disabled");
	            	document.getElementById(dayId).value = "";
	        	}
		        else{
		        	document.getElementById(dayId).removeAttribute("disabled");
		            if(day == "" || !regExp.test(day)){
		            	document.getElementById(dayId).value = "";
		        	}
	        	}
	        }
	    }
    </script>

</html>
